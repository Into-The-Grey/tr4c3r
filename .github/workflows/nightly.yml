name: Nightly Build & Test

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      full_matrix:
        description: 'Run full test matrix'
        type: boolean
        default: false
      notify_on_success:
        description: 'Create issue on success too'
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  nightly-test:
    name: Nightly Test Suite
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.coverage.outputs.coverage }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pipenv
          pipenv install --dev --system

      - name: Run comprehensive test suite
        run: |
          pip install pytest-cov pytest-timeout pytest-xdist pytest-html pytest-benchmark
          pytest tests/ -v \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --timeout=120 \
            --html=test-report.html \
            --self-contained-html \
            -n auto \
            --benchmark-disable

      - name: Extract coverage percentage
        id: coverage
        run: |
          if [ -f coverage.xml ]; then
            COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); print(f\"{float(tree.getroot().attrib['line-rate'])*100:.1f}\")")
          else
            echo "Warning: coverage.xml not found. Setting coverage to 0.0."
            COVERAGE="0.0"
          fi
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-test-results
          path: |
            coverage.xml
            htmlcov/
            test-report.html
          retention-days: 14

      - name: Add coverage badge
        run: |
          echo "## ðŸ“Š Nightly Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${{ steps.coverage.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY

  nightly-build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: macos-14
            platform: macos
            arch: arm64
          - os: windows-latest
            platform: windows
            arch: x64
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pipenv pyinstaller
          pipenv install --dev --system

      - name: Build (Unix)
        if: runner.os != 'Windows'
        run: |
          chmod +x scripts/build-portable.sh
          ./scripts/build-portable.sh --platform ${{ matrix.platform }}
        timeout-minutes: 30

      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: .\scripts\build-portable.bat
        timeout-minutes: 30

      - name: Verify build output
        shell: bash
        run: |
          if [[ "${{ matrix.platform }}" == "windows" ]]; then
            ls -la releases/*.zip || exit 1
          else
            ls -la releases/*.tar.gz || exit 1
          fi

      - name: Upload nightly build
        uses: actions/upload-artifact@v4
        with:
          name: nightly-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            releases/*.tar.gz
            releases/*.zip
          retention-days: 7

  performance-benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pipenv
          pipenv install --dev --system
          pip install pytest-benchmark

      - name: Run benchmarks
        run: |
          pytest tests/ --benchmark-only --benchmark-json=benchmark.json || true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark.json
          retention-days: 30

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pipenv
          pipenv install --dev --system

      - name: Run integration tests
        run: |
          pytest tests/test_integration.py -v --timeout=300 || true
        env:
          REDIS_URL: redis://localhost:6379

  notify-results:
    name: Notify Results
    needs: [nightly-test, nightly-build, performance-benchmark, integration-test]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      issues: write
    steps:
      - name: Determine overall status
        id: status
        run: |
          if [[ "${{ needs.nightly-test.result }}" == "failure" ]] || \
             [[ "${{ needs.nightly-build.result }}" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: Create/Update failure issue
        if: steps.status.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `ðŸš¨ Nightly Build Failed - ${date}`;
            const body = `
            ## Nightly Build Failure Report
            
            | Job | Status |
            |-----|--------|
            | Test Suite | ${{ needs.nightly-test.result == 'success' && 'âœ…' || 'âŒ' }} |
            | Build | ${{ needs.nightly-build.result == 'success' && 'âœ…' || 'âŒ' }} |
            | Benchmarks | ${{ needs.performance-benchmark.result == 'success' && 'âœ…' || 'âš ï¸' }} |
            | Integration | ${{ needs.integration-test.result == 'success' && 'âœ…' || 'âš ï¸' }} |
            
            **Run:** [View Details](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ---
            *Auto-generated by nightly workflow*
            `;
            
            // Find existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'nightly-failure',
              per_page: 5
            });
            
            if (issues.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `## Update - ${date}\n\n${body}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'nightly-failure', 'automated']
              });
            }

      - name: Close old failure issues on success
        if: steps.status.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'nightly-failure',
              per_page: 10
            });
            
            for (const issue of issues) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âœ… Nightly build is now passing. Closing this issue.'
              });
            }

      - name: Generate summary
        run: |
          echo "## ðŸŒ™ Nightly Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${{ needs.nightly-test.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | ${{ needs.nightly-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Builds | ${{ needs.nightly-build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Benchmarks | ${{ needs.performance-benchmark.result == 'success' && 'âœ… Passed' || 'âš ï¸ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration-test.result == 'success' && 'âœ… Passed' || 'âš ï¸ Issues' }} |" >> $GITHUB_STEP_SUMMARY
