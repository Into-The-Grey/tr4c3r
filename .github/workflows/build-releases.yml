name: Build Portable Releases

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      prerelease:
        description: 'Mark as pre-release'
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Extract version from tag or input
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

  # Build for Linux x64
  build-linux-x64:
    name: Build Linux x64
    needs: prepare
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('Pipfile.lock') }}
          restore-keys: ${{ runner.os }}-pip-
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pipenv pyinstaller
          pipenv install --dev --system
          
      - name: Update version in build script
        run: |
          sed -i "s/VERSION=\"1.0.0\"/VERSION=\"$VERSION\"/" scripts/build-portable.sh
          
      - name: Build portable package
        run: |
          chmod +x scripts/build-portable.sh
          ./scripts/build-portable.sh --platform linux
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tr4c3r-${{ env.VERSION }}-linux-x64
          path: releases/*.tar.gz
          retention-days: 7

  # Build for Linux ARM64
  build-linux-arm64:
    name: Build Linux ARM64
    needs: prepare
    runs-on: ubuntu-24.04-arm
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pipenv pyinstaller
          pipenv install --dev --system
          
      - name: Update version in build script
        run: |
          sed -i "s/VERSION=\"1.0.0\"/VERSION=\"$VERSION\"/" scripts/build-portable.sh
          
      - name: Build portable package
        run: |
          chmod +x scripts/build-portable.sh
          ./scripts/build-portable.sh --platform linux
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tr4c3r-${{ env.VERSION }}-linux-arm64
          path: releases/*.tar.gz
          retention-days: 7
          
  # Build for macOS Intel
  build-macos-intel:
    name: Build macOS Intel (x64)
    needs: prepare
    runs-on: macos-13
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-x64-pip-${{ hashFiles('Pipfile.lock') }}
          restore-keys: ${{ runner.os }}-x64-pip-
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pipenv pyinstaller
          pipenv install --dev --system
          
      - name: Update version in build script
        run: |
          sed -i '' "s/VERSION=\"1.0.0\"/VERSION=\"$VERSION\"/" scripts/build-portable.sh
          
      - name: Build portable package
        run: |
          chmod +x scripts/build-portable.sh
          ./scripts/build-portable.sh --platform macos
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tr4c3r-${{ env.VERSION }}-macos-x64
          path: releases/*.tar.gz
          retention-days: 7

  # Build for macOS Apple Silicon
  build-macos-arm:
    name: Build macOS Apple Silicon (ARM64)
    needs: prepare
    runs-on: macos-14
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-arm64-pip-${{ hashFiles('Pipfile.lock') }}
          restore-keys: ${{ runner.os }}-arm64-pip-
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pipenv pyinstaller
          pipenv install --dev --system
          
      - name: Update version in build script
        run: |
          sed -i '' "s/VERSION=\"1.0.0\"/VERSION=\"$VERSION\"/" scripts/build-portable.sh
          
      - name: Build portable package
        run: |
          chmod +x scripts/build-portable.sh
          ./scripts/build-portable.sh --platform macos
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tr4c3r-${{ env.VERSION }}-macos-arm64
          path: releases/*.tar.gz
          retention-days: 7

  # Build for Windows x64
  build-windows-x64:
    name: Build Windows x64
    needs: prepare
    runs-on: windows-latest
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('Pipfile.lock') }}
          restore-keys: ${{ runner.os }}-pip-
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pipenv pyinstaller
          pipenv install --dev --system
          
      - name: Update version in build script
        run: |
          (Get-Content scripts\build-portable.bat) -replace 'VERSION=1.0.0', "VERSION=$env:VERSION" | Set-Content scripts\build-portable.bat
          
      - name: Build portable package
        run: .\scripts\build-portable.bat
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tr4c3r-${{ env.VERSION }}-windows-x64
          path: releases/*.zip
          retention-days: 7

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    needs: [prepare, build-linux-x64, build-linux-arm64, build-macos-intel, build-macos-arm, build-windows-x64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    env:
      VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          
      - name: Display structure
        run: |
          echo "Artifact structure:"
          find artifacts -type f -name "*.tar.gz" -o -name "*.zip" | sort
          
      - name: Prepare release files
        run: |
          mkdir -p release-files
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release-files/ \;
          ls -la release-files/
          
      - name: Generate changelog
        id: changelog
        run: |
          echo "## What's Changed" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            echo "Changes since $LAST_TAG:" >> CHANGELOG.md
            git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" >> CHANGELOG.md
          else
            echo "Initial release" >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Downloads" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "| Platform | Architecture | File |" >> CHANGELOG.md
          echo "|----------|--------------|------|" >> CHANGELOG.md
          echo "| Linux | x64 | \`tr4c3r-$VERSION-linux-x64.tar.gz\` |" >> CHANGELOG.md
          echo "| Linux | ARM64 | \`tr4c3r-$VERSION-linux-arm64.tar.gz\` |" >> CHANGELOG.md
          echo "| macOS | Intel (x64) | \`tr4c3r-$VERSION-macos-x64.tar.gz\` |" >> CHANGELOG.md
          echo "| macOS | Apple Silicon (ARM64) | \`tr4c3r-$VERSION-macos-arm64.tar.gz\` |" >> CHANGELOG.md
          echo "| Windows | x64 | \`tr4c3r-$VERSION-windows-x64.zip\` |" >> CHANGELOG.md
          
          cat CHANGELOG.md
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: TR4C3R v${{ env.VERSION }}
          body_path: CHANGELOG.md
          files: release-files/*
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          generate_release_notes: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Notify on completion
  notify:
    name: Release Summary
    needs: [prepare, create-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Release Summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Built:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linux x64" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linux ARM64" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… macOS Intel (x64)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… macOS Apple Silicon (ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Windows x64" >> $GITHUB_STEP_SUMMARY
