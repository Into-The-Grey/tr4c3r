name: Security Scan

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'Pipfile*'
      - 'requirements*.txt'
      - '.github/workflows/security.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'Pipfile*'
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install scanning tools
        run: pip install pipenv safety pip-audit

      - name: Generate requirements
        run: |
          pipenv requirements > requirements.txt
          pipenv requirements --dev > requirements-dev.txt

      - name: Run pip-audit
        id: pip_audit
        run: |
          echo "## ðŸ” Dependency Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pip-audit -r requirements.txt --format markdown >> $GITHUB_STEP_SUMMARY || true

      - name: Run Safety check
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ›¡ï¸ Safety Check Results" >> $GITHUB_STEP_SUMMARY
          safety check -r requirements.txt --full-report >> $GITHUB_STEP_SUMMARY 2>&1 || true

      - name: Check for critical vulnerabilities
        run: |
          # Fail on high/critical vulnerabilities
          pip-audit -r requirements.txt --vulnerability-service osv --strict

  code-scan:
    name: Static Code Analysis (Bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          echo "## ðŸ” Bandit Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          bandit -r src/ -f markdown -o bandit-report.md -ll || true
          cat bandit-report.md >> $GITHUB_STEP_SUMMARY

      - name: Generate SARIF report
        run: bandit -r src/ -f sarif -o bandit-results.sarif || true

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: bandit-results.sarif
          category: bandit

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secrets Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified --fail

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: +security-extended,security-and-quality
          config: |
            paths:
              - src
            paths-ignore:
              - tests
              - docs

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-licenses
        run: |
          pip install pipenv pip-licenses
          pipenv install --system

      - name: Check licenses
        run: |
          echo "## ðŸ“œ License Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pip-licenses --format=markdown >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check for problematic licenses
        run: |
          # Fail if GPL or other copyleft licenses are found (adjust as needed)
          PROBLEMATIC=$(pip-licenses --fail-on="GPL;AGPL" 2>&1) || true
          if echo "$PROBLEMATIC" | grep -q "fail-on"; then
            echo "::warning::Potentially problematic licenses detected"
          fi

  security-summary:
    name: Security Summary
    needs: [dependency-scan, code-scan, secrets-scan, codeql, license-check]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Scan (Bandit) | ${{ needs.code-scan.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Detection | ${{ needs.secrets-scan.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
