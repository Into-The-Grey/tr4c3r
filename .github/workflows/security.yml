name: Security Scan

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'Pipfile*'
      - 'requirements*.txt'
      - '.github/workflows/security.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'Pipfile*'
      - 'requirements*.txt'
      - '.github/workflows/security.yml'
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install scanning tools
        run: pip install pipenv pip-audit

      - name: Generate requirements
        run: |
          pipenv requirements > requirements.txt
          pipenv requirements --dev > requirements-dev.txt

      - name: Run pip-audit
        id: pip_audit
        continue-on-error: true
        run: |
          echo "## ðŸ” Dependency Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pip-audit -r requirements.txt --format markdown >> $GITHUB_STEP_SUMMARY

      - name: Check for critical vulnerabilities
        run: |
          # Fail on high/critical vulnerabilities
          pip-audit -r requirements.txt --vulnerability-service osv --strict

  code-scan:
    name: Static Code Analysis (Bandit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit security scan
        continue-on-error: true
        run: |
          echo "## ðŸ” Bandit Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "src/" ]; then
            bandit -r src/ -f markdown -o bandit-report.md -ll
            cat bandit-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ src/ directory not found, skipping Bandit scan" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate SARIF report
        continue-on-error: true
        run: |
          if [ -d "src/" ]; then
            bandit -r src/ -f sarif -o bandit-results.sarif
          else
            echo '{"version":"2.1.0","runs":[]}' > bandit-results.sarif
          fi

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: bandit-results.sarif
          category: bandit

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secrets Scan
        uses: trufflesecurity/trufflehog@v3.82.13
        with:
          extra_args: --only-verified --fail

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2.3.7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: +security-extended,security-and-quality
          config: |
            paths:
              - src
            paths-ignore:
              - tests
              - docs

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-licenses
        run: |
          pip install pipenv pip-licenses
          # Try with --deploy for strict lockfile matching, fallback without it for environments without lockfile
          pipenv install --system --deploy || pipenv install --system

      - name: Check licenses
        run: |
          echo "## ðŸ“œ License Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pip-licenses --format=markdown >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check for problematic licenses
        run: |
          # Only allow OSI-approved permissive licenses
          # Includes: MIT, BSD variants, Apache 2.0, ISC, PSF, Unlicense, CC0, MPL-2.0
          pip-licenses --allow-only="MIT;MIT License;BSD;BSD License;BSD-2-Clause;BSD-3-Clause;Apache 2.0;Apache License 2.0;Apache Software License;ISC;ISC License;Python Software Foundation License;PSF;PSFL;Unlicense;Public Domain;CC0;MPL-2.0;Mozilla Public License 2.0"

  security-summary:
    name: Security Summary
    needs: [dependency-scan, code-scan, secrets-scan, codeql, license-check]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && 'âœ…' || (needs.dependency-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Scan (Bandit) | ${{ needs.code-scan.result == 'success' && 'âœ…' || (needs.code-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Detection | ${{ needs.secrets-scan.result == 'success' && 'âœ…' || (needs.secrets-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql.result == 'success' && 'âœ…' || (needs.codeql.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result == 'success' && 'âœ…' || (needs.license-check.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ') }} |" >> $GITHUB_STEP_SUMMARY
